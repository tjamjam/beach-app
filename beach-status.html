<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakewood Beach Status</title>
    <!-- We need to include a special library to read PDFs in the browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        body { background-color: #f0f0f0; font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #333; }
        .container { text-align: center; background-color: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 90%; }
        h1 { margin-top: 0; }
        .stoplight { background-color: #222; width: 120px; height: 340px; border-radius: 20px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 20px 0; margin: 20px auto; border: 5px solid #111; }
        .light { width: 90px; height: 90px; border-radius: 50%; background-color: #444; transition: all 0.3s ease; }
        .light.red { background-color: #ff1c1c; box-shadow: 0 0 25px #ff1c1c; }
        .light.yellow { background-color: #ffdd00; box-shadow: 0 0 25px #ffdd00; }
        .light.green { background-color: #00ff6a; box-shadow: 0 0 25px #00ff6a; }
        #status-text { font-size: 1.5em; font-weight: bold; margin-top: 20px; min-height: 1.5em; }
        .timestamp { font-size: 0.8em; color: #888; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lakewood Beach Status</h1>
        <div class="stoplight">
            <div id="red-light" class="light"></div>
            <div id="yellow-light" class="light"></div>
            <div id="green-light" class="light"></div>
        </div>
        <div id="loader" class="loader"></div>
        <p id="status-text"></p>
        <p class="timestamp">Last updated: <span id="last-updated"></span></p>
    </div>

    <script>
        // Set the workerSrc for the PDF.js library
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        document.addEventListener('DOMContentLoaded', () => {
            const BEACH_REPORT_URL = 'https://anrweb.vt.gov/FPR/SwimWater/CityOfBurlingtonPublicReport.aspx';
            // We use a public CORS proxy to get around browser security rules.
            const PROXY_URL = 'https://cors-anywhere.herokuapp.com/';
            const TARGET_BEACH = "Leddy Beach South";

            const redLight = document.getElementById('red-light');
            const yellowLight = document.getElementById('yellow-light');
            const greenLight = document.getElementById('green-light');
            const statusText = document.getElementById('status-text');
            const loader = document.getElementById('loader');

            async function fetchAndParsePdf() {
                try {
                    statusText.textContent = 'Fetching report...';
                    const response = await fetch(PROXY_URL + BEACH_REPORT_URL);
                    if (!response.ok) throw new Error('Network response was not ok');

                    const pdfData = await response.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    const page = await pdf.getPage(1);
                    const textContent = await page.getTextContent();
                    
                    statusText.textContent = 'Parsing status...';
                    const status = findStatusInPdfText(textContent.items);
                    updateStoplight(status);

                } catch (error) {
                    console.error("Failed to fetch or parse PDF:", error);
                    // This is a common issue with the public proxy. Add a user-friendly message.
                    if (error.message.includes('403')) {
                         statusText.innerHTML = 'Error: Proxy access needed. Please <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">click here to activate the temporary proxy</a>, then refresh this page.';
                         loader.style.display = 'none';
                    } else {
                        updateStoplight('error');
                    }
                }
            }
            
            function findStatusInPdfText(pdfItems) {
                // Find the item for "Leddy Beach South"
                const beachItem = pdfItems.find(item => item.str.includes(TARGET_BEACH));
                if (!beachItem) return 'not_found';

                // Get the vertical position (y-coordinate) of our target beach
                const beachY = beachItem.transform[5];

                // Now, look for the 'Status' text items that are on the same line (similar y-coordinate)
                const possibleStatuses = ['Open', 'Advisory', 'Closed'];
                for (const item of pdfItems) {
                    const itemY = item.transform[5];
                    const isSameLine = Math.abs(itemY - beachY) < 5; // Allow for small vertical deviation

                    if (isSameLine && possibleStatuses.some(s => item.str.includes(s))) {
                        const statusStr = item.str.toLowerCase();
                        if (statusStr.includes("open")) return "green";
                        if (statusStr.includes("advisory")) return "yellow";
                        if (statusStr.includes("closed")) return "red";
                    }
                }
                return 'unknown';
            }

            function updateStoplight(status) {
                loader.style.display = 'none';
                redLight.classList.remove('red');
                yellowLight.classList.remove('yellow');
                greenLight.classList.remove('green');

                let message = '';
                let color = '#555';

                switch (status) {
                    case 'green':
                        greenLight.classList.add('green');
                        message = 'Open for Swimming';
                        color = '#00a045';
                        break;
                    case 'yellow':
                        yellowLight.classList.add('yellow');
                        message = 'Advisory / Caution';
                        color = '#c7a900';
                        break;
                    case 'red':
                        redLight.classList.add('red');
                        message = 'Closed for Swimming';
                        color = '#c21616';
                        break;
                    case 'not_found':
                        message = 'Leddy Beach South not found in report.';
                        break;
                    default:
                        message = 'Could not determine status.';
                        break;
                }
                statusText.textContent = message;
                statusText.style.color = color;
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            }

            fetchAndParsePdf();
        });
    </script>
</body>
</html>
