<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burlington Beach Status - All City Beaches</title>
    <meta name="description" content="Real-time water quality status for all Burlington beaches. Check current conditions, weather, and air quality for your perfect beach day.">
    
    <!-- Tailwind CSS -->
    <link href="./dist/output.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-water text-primary-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Burlington Beaches</h1>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    <span id="last-updated">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Hero Section -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-900 mb-4">Find Your Perfect Beach</h2>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Real-time water quality status for all Burlington beaches. Check current conditions and plan your perfect beach day.
            </p>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <div class="relative max-w-md mx-auto">
                <input type="text" id="beach-search" placeholder="Search beaches..." 
                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Beach List -->
            <div class="order-2 lg:order-1">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">All Beaches</h3>
                    <div id="beach-list" class="space-y-3">
                        <!-- Beaches will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="order-1 lg:order-2">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Beach Map</h3>
                    <div id="map" class="h-96 rounded-lg overflow-hidden"></div>
                </div>
            </div>
        </div>

        <!-- Historical Timeline -->
        <div class="mt-8">
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Historical Timeline</h3>
                <p class="text-gray-600 mb-4">See how beach conditions have changed over time</p>
                <div id="timeline-content">
                    <!-- Timeline will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center">
                <p class="text-gray-300">
                    Data provided by Vermont Department of Health • 
                    Weather data from OpenWeatherMap • 
                    Air quality data from AirNow
                </p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom JS -->
    <script>
        // Configuration
        const BASE_API_URL = "https://beach-api.terrencefradet.workers.dev";
        let map;
        let beaches = [];
        let fakeHistoricalData = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            fetchBeachData();
            fetchHistoricalData();
            setupSearch();
        });

        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('map').setView([44.48, -73.22], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Fetch beach data from status.json
        async function fetchBeachData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/tjamjam/beach-app/main/status.json');
                if (!response.ok) throw new Error('Failed to fetch beach data');
                
                beaches = await response.json();
                displayBeaches();
                updateMap();
                updateLastUpdated();
                
            } catch (error) {
                console.error('Error fetching beach data:', error);
                document.getElementById('beach-list').innerHTML = `
                    <div class="text-red-600 text-center py-8">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load beach data. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Display beaches in the list
        function displayBeaches() {
            const beachList = document.getElementById('beach-list');
            beachList.innerHTML = '';

            beaches.forEach(beach => {
                const statusClass = getStatusClass(beach.status);
                const statusText = getStatusText(beach.status);
                
                const beachCard = document.createElement('div');
                beachCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                beachCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${beach.beach_name}</h4>
                            <p class="text-sm text-gray-600 mt-1">${beach.note || 'No additional information'}</p>
                            <p class="text-xs text-gray-500 mt-1">Last updated: ${beach.date}</p>
                        </div>
                        <div class="ml-4">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
                
                beachCard.addEventListener('click', () => {
                    if (beach.coordinates) {
                        map.setView([beach.coordinates.lat, beach.coordinates.lon], 15);
                    }
                });
                
                beachList.appendChild(beachCard);
            });
        }

        // Update map with beach markers
        function updateMap() {
            // Clear existing markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            beaches.forEach(beach => {
                if (beach.coordinates) {
                    const statusClass = getStatusClass(beach.status);
                    const statusText = getStatusText(beach.status);
                    
                    const marker = L.marker([beach.coordinates.lat, beach.coordinates.lon])
                        .addTo(map)
                        .bindPopup(`
                            <div class="text-center">
                                <h3 class="font-semibold text-lg">${beach.beach_name}</h3>
                                <span class="status-badge ${statusClass} mt-2">${statusText}</span>
                                <p class="text-sm text-gray-600 mt-2">${beach.note || 'No additional information'}</p>
                                <p class="text-xs text-gray-500 mt-1">Updated: ${beach.date}</p>
                            </div>
                        `);
                }
            });
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('beach-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const beachCards = document.querySelectorAll('#beach-list > div');
                
                beachCards.forEach(card => {
                    const beachName = card.querySelector('h4').textContent.toLowerCase();
                    if (beachName.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        // Fetch historical data for timeline
        async function fetchHistoricalData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/tjamjam/beach-app/main/backend/historical_status.csv');
                if (!response.ok) throw new Error('Failed to fetch historical data');
                
                const csvText = await response.text();
                const historicalData = parseCSV(csvText);
                fakeHistoricalData = historicalData;
                updateTimeline(historicalData);
                
            } catch (error) {
                console.error('Error fetching historical data:', error);
                document.getElementById('timeline-content').innerHTML = `
                    <div class="text-red-600 text-center py-8">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load historical data. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        // Update timeline visualization
        function updateTimeline(data) {
            const timelineContent = document.getElementById('timeline-content');
            
            if (!data || data.length === 0) {
                timelineContent.innerHTML = '<p class="text-gray-500 text-center">No historical data available</p>';
                return;
            }

            // Group data by date and beach
            const groupedData = {};
            data.forEach(row => {
                const date = new Date(row.record_timestamp_utc).toISOString().split('T')[0];
                if (!groupedData[date]) groupedData[date] = {};
                groupedData[date][row.beach_name] = row.status;
            });

            // Create timeline visualization
            const dates = Object.keys(groupedData).sort();
            const beachNames = [...new Set(data.map(row => row.beach_name))];
            
            const timelineHTML = `
                <div class="overflow-x-auto">
                    <div class="min-w-max">
                        <div class="grid grid-cols-${dates.length + 1} gap-2 text-xs">
                            <div class="font-semibold p-2">Beach</div>
                            ${dates.map(date => `
                                <div class="font-semibold p-2 text-center">${new Date(date).toLocaleDateString()}</div>
                            `).join('')}
                            
                            ${beachNames.map(beach => `
                                <div class="font-medium p-2 border-t">${beach}</div>
                                ${dates.map(date => {
                                    const status = groupedData[date]?.[beach] || 'unknown';
                                    const statusClass = getStatusClass(status);
                                    return `<div class="p-2 text-center">
                                        <span class="status-badge ${statusClass} text-xs">${status}</span>
                                    </div>`;
                                }).join('')}
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            timelineContent.innerHTML = timelineHTML;
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            if (beaches.length > 0) {
                const latestUpdate = beaches.reduce((latest, beach) => {
                    const beachDate = new Date(beach.date);
                    return beachDate > latest ? beachDate : latest;
                }, new Date(0));
                
                document.getElementById('last-updated').textContent = 
                    latestUpdate.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: 'numeric', 
                        minute: '2-digit' 
                    });
            }
        }

        // Helper functions
        function getStatusClass(status) {
            switch(status) {
                case 'green': return 'status-badge-green';
                case 'yellow': return 'status-badge-yellow';
                case 'red': return 'status-badge-red';
                default: return 'bg-gray-500 text-white';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'green': return 'Open';
                case 'yellow': return 'Alert';
                case 'red': return 'Closed';
                default: return 'Unknown';
            }
        }
    </script>
</body>
</html>
