<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakewood Beach Status - Water Quality & Conditions</title>
    <meta name="description" content="Real-time water quality status for Lakewood Beach. Check current conditions, weather, and air quality for your perfect beach day.">
    
    <!-- Tailwind CSS -->
    <link href="./dist/output.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-water text-primary-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Lakewood Beach</h1>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    <span id="last-updated">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Status Card -->
        <div class="card p-6 mb-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Current Status</h2>
                <div id="status-display" class="text-6xl mb-4">
                    <!-- Status will be populated here -->
                </div>
                <p id="status-text" class="text-xl text-gray-600 mb-4">
                    <!-- Status text will be populated here -->
                </p>
                <div id="status-note-container" class="mb-4" style="display: none;">
                    <p class="text-sm text-gray-500 mb-1">Note:</p>
                    <p id="status-note" class="text-gray-600 bg-gray-50 rounded-lg p-3">
                        <!-- Additional notes will be populated here -->
                    </p>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <a href="https://anrweb.vt.gov/FPR/SwimWater/CityOfBurlingtonPublicReport.aspx" target="_blank" class="text-sm text-primary-600 hover:text-primary-700">
                        <i class="fas fa-file-pdf mr-1"></i>
                        View official water quality report
                    </a>
                </div>
            </div>
        </div>

        <!-- Weather and Air Quality Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Current Weather Widget -->
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-cloud-sun text-primary-600 mr-2"></i>
                    Current Weather
                </h3>
                <div id="weather-content" class="text-center">
                    <div class="text-4xl font-bold text-gray-900 mb-2">
                        <span id="temperature">--</span>¬∞F
                    </div>
                    <div class="text-lg text-gray-600 mb-4">
                        <span id="conditions">Loading...</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <i class="fas fa-wind text-gray-400 mr-1"></i>
                            <span id="wind-speed">--</span> mph
                        </div>
                        <div>
                            <i class="fas fa-tint text-gray-400 mr-1"></i>
                            <span id="humidity">--</span>%
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <a href="https://openweathermap.org/city/5233828" target="_blank" class="text-sm text-primary-600 hover:text-primary-700">
                            <i class="fas fa-external-link-alt mr-1"></i>
                            View detailed forecast
                        </a>
                    </div>
                </div>
            </div>

            <!-- Air Quality Widget -->
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-leaf text-primary-600 mr-2"></i>
                    Air Quality
                </h3>
                <div id="air-quality-content" class="text-center">
                    <div class="text-4xl font-bold text-gray-900 mb-2">
                        <span id="aqi">--</span>
                    </div>
                    <div class="text-lg text-gray-600 mb-4">
                        <span id="aqi-text">Loading...</span>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span id="aqi-advice">Checking air quality...</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <a href="https://www.airnow.gov/?city=Burlington&state=VT&country=USA" target="_blank" class="text-sm text-primary-600 hover:text-primary-700">
                            <i class="fas fa-external-link-alt mr-1"></i>
                            View detailed air quality
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Weather and Wave Report Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Upcoming Weather Widget -->
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-calendar-alt text-primary-600 mr-2"></i>
                    Upcoming Weather
                </h3>
                <div id="upcoming-weather-content">
                    <div class="text-sm text-gray-500 text-center">Loading hourly forecast...</div>
                </div>
            </div>

            <!-- Wave Report Widget -->
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-water text-primary-600 mr-2"></i>
                    Wave Report
                </h3>
                <div id="wave-report-content">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-4">
                        <div>
                            <div class="text-3xl font-bold text-gray-900">
                                <span id="wave-height">--</span> ft
                            </div>
                            <div class="text-sm text-gray-600">Height</div>
                        </div>
                        <div>
                            <div class="text-xl font-semibold text-gray-900">
                                <span id="wave-direction">--</span>
                            </div>
                            <div class="text-sm text-gray-600">Direction</div>
                        </div>
                        <div>
                            <div class="text-lg font-semibold text-gray-900">
                                <span id="wave-period">--</span>
                            </div>
                            <div class="text-sm text-gray-600">Period</div>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-200">
                        <a href="https://www.ndbc.noaa.gov/station_page.php?station=45165" target="_blank" class="text-sm text-primary-600 hover:text-primary-700">
                            <i class="fas fa-external-link-alt mr-1"></i>
                            View detailed wave data
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alternative Beach Info -->
        <div id="alternative-beach-section" class="card p-6 mb-8" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-map-marker-alt text-primary-600 mr-2"></i>
                Alternative Beaches
            </h3>
            <div id="alternative-beach-info">
                <!-- Alternative beach information will be populated here -->
            </div>
        </div>

        <!-- Email Subscription -->
        <div class="card p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-bell text-primary-600 mr-2"></i>
                Get Notifications
            </h3>
            <p class="text-gray-600 mb-4">
                Subscribe to receive email notifications when Lakewood Beach status changes.
            </p>
            <form id="subscription-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Address
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="your@email.com">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Subscribe to Notifications
                </button>
            </form>
            <div id="subscription-message" class="mt-4" style="display: none;">
                <!-- Subscription messages will be shown here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center">
                <p class="text-gray-300">
                    Data provided by Vermont Department of Health ‚Ä¢ 
                    Weather data from OpenWeatherMap ‚Ä¢ 
                    Air quality data from AirNow
                </p>
            </div>
        </div>
    </footer>

    <!-- Custom JS -->
    <script>
        // Configuration
        const BASE_API_URL = "https://beach-api.terrencefradet.workers.dev";
        const LAKEWOOD_BEACH = {
            lat: 44.501457,
            lon: -73.252218
        };
        let allBeaches = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchBeachData();
            fetchWeatherData();
            fetchAirQualityData();
            fetchUpcomingWeather();
            fetchWaveData();
            setupSubscriptionForm();
        });

        // Fetch beach data
        async function fetchBeachData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/tjamjam/beach-app/main/status.json');
                if (!response.ok) throw new Error('Failed to fetch beach data');
                
                allBeaches = await response.json();
                const lakewoodBeach = allBeaches.find(b => b.beach_name === "Leddy Beach South");
                
                if (lakewoodBeach) {
                    displayStatus(lakewoodBeach);
                    displayAlternativeBeach(allBeaches, "Leddy Beach South");
                } else {
                    displayError("Lakewood Beach data not available");
                }
                
                updateLastUpdated();
                
            } catch (error) {
                console.error('Error fetching beach data:', error);
                displayError("Failed to load beach data");
            }
        }

        // Display status
        function displayStatus(beach) {
            const statusDisplay = document.getElementById('status-display');
            const statusText = document.getElementById('status-text');
            const statusNote = document.getElementById('status-note');
            const statusNoteContainer = document.getElementById('status-note-container');
            
            let statusIcon, statusClass, statusDescription;
            
            switch(beach.status) {
                case 'green':
                    statusIcon = 'üü¢';
                    statusClass = 'text-beach-green';
                    statusDescription = 'OPEN';
                    break;
                case 'yellow':
                    statusIcon = 'üü°';
                    statusClass = 'text-beach-yellow';
                    statusDescription = 'ALERT';
                    break;
                case 'red':
                    statusIcon = 'üî¥';
                    statusClass = 'text-beach-red';
                    statusDescription = 'CLOSED';
                    break;
                default:
                    statusIcon = '‚ö™';
                    statusClass = 'text-gray-500';
                    statusDescription = 'UNKNOWN';
            }
            
            statusDisplay.innerHTML = `<span class="${statusClass}">${statusIcon}</span>`;
            statusText.textContent = statusDescription;
            
            // Show note container only if there's a note
            if (beach.note && beach.note.trim() !== '') {
                statusNote.textContent = beach.note;
                statusNoteContainer.style.display = 'block';
            } else {
                statusNoteContainer.style.display = 'none';
            }
        }

        // Display alternative beach information
        function displayAlternativeBeach(allBeaches, targetBeachName) {
            const targetBeach = allBeaches.find(b => b.beach_name === targetBeachName);
            const adviceContainer = document.getElementById('alternative-beach-info');
            const alternativeSection = document.getElementById('alternative-beach-section');

            // If the target beach is open or we can't find its data, hide the suggestion
            if (!targetBeach || targetBeach.status === 'green' || !targetBeach.coordinates) {
                alternativeSection.style.display = 'none';
                return;
            }

            const openBeaches = allBeaches.filter(b => b.status === 'green' && b.coordinates);

            // If the list of open beaches is empty, display the specific message
            if (openBeaches.length === 0) {
                adviceContainer.innerHTML = `
                    <p class="text-gray-600 italic">There are no other open beaches at this time.</p>
                `;
                alternativeSection.style.display = 'block';
                return;
            }

            // Calculate distances and find the closest
            const targetCoords = targetBeach.coordinates;
            let closestBeach = null;
            let shortestDistance = Infinity;

            openBeaches.forEach(beach => {
                const distance = calculateDistance(
                    targetCoords.lat, targetCoords.lon,
                    beach.coordinates.lat, beach.coordinates.lon
                );
                
                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    closestBeach = beach;
                }
            });

            if (closestBeach) {
                const distanceText = shortestDistance < 1 ? 
                    `${Math.round(shortestDistance * 1000)}m away` : 
                    `${shortestDistance.toFixed(1)}km away`;

                adviceContainer.innerHTML = `
                    <p class="text-gray-600 mb-2">Instead, the closest open beach is:</p>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900">${closestBeach.beach_name}</h4>
                        <p class="text-sm text-gray-600 mt-1">${distanceText}</p>
                        <p class="text-sm text-gray-500 mt-1">${closestBeach.note || 'No additional information'}</p>
                    </div>
                `;
                alternativeSection.style.display = 'block';
            }
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Fetch weather data
        async function fetchWeatherData() {
            try {
                const response = await fetch(`${BASE_API_URL}/weather`);
                if (!response.ok) throw new Error('Weather API failed');
                
                const data = await response.json();
                displayWeather(data.current);
                
            } catch (error) {
                console.error('Error fetching weather:', error);
                document.getElementById('weather-content').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Weather data unavailable</p>
                    </div>
                `;
            }
        }

        // Display weather data
        function displayWeather(weather) {
            document.getElementById('temperature').textContent = weather.temperature;
            document.getElementById('conditions').textContent = weather.conditions;
            document.getElementById('wind-speed').textContent = weather.windSpeed;
            document.getElementById('humidity').textContent = weather.humidity;
        }

        // Fetch air quality data
        async function fetchAirQualityData() {
            try {
                const response = await fetch(`${BASE_API_URL}/air-quality`);
                if (!response.ok) throw new Error('Air quality API failed');
                
                const data = await response.json();
                displayAirQuality(data);
                
            } catch (error) {
                console.error('Error fetching air quality:', error);
                document.getElementById('air-quality-content').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Air quality data unavailable</p>
                    </div>
                `;
            }
        }

        // Display air quality data
        function displayAirQuality(data) {
            document.getElementById('aqi').textContent = data.aqi;
            document.getElementById('aqi-text').textContent = data.text;
            document.getElementById('aqi-advice').textContent = data.advice;
        }

        // Fetch upcoming weather data
        async function fetchUpcomingWeather() {
            try {
                const response = await fetch(`${BASE_API_URL}/weather`);
                if (!response.ok) throw new Error('Weather API failed');
                
                const data = await response.json();
                displayUpcomingWeather(data.hourly);
                
            } catch (error) {
                console.error('Error fetching upcoming weather:', error);
                document.getElementById('upcoming-weather-content').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Upcoming weather data unavailable</p>
                    </div>
                `;
            }
        }

        // Display upcoming weather data
        function displayUpcomingWeather(hourlyData) {
            const container = document.getElementById('upcoming-weather-content');
            
            if (!hourlyData || hourlyData.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No forecast data available</div>';
                return;
            }

            const forecastHTML = hourlyData.map(hour => `
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-3 border-b border-gray-100 last:border-b-0">
                    <!-- Time and Temperature (grouped together) -->
                    <div class="flex items-center justify-between sm:justify-start mb-2 sm:mb-0">
                        <div class="text-left">
                            <div class="font-semibold text-gray-900">${hour.time}</div>
                            <div class="text-2xl font-bold text-gray-900">${hour.temp}¬∞F</div>
                        </div>
                    </div>
                    
                    <!-- Icon and Description (grouped together) -->
                    <div class="flex items-center justify-center sm:justify-end">
                        <div class="flex flex-col items-center">
                            <img src="${hour.icon}" alt="${hour.description}" class="w-12 h-12 mb-1">
                            <div class="text-sm text-gray-600 text-center">${hour.description}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="space-y-1">
                    ${forecastHTML}
                </div>
            `;
        }

        // Fetch wave data (mock data for now)
        async function fetchWaveData() {
            try {
                // For now, we'll use mock data since we don't have a wave API
                // In the future, this could connect to NOAA buoy data
                const mockWaveData = {
                    height: "1-2",
                    direction: "Southeast",
                    period: "3-5 seconds"
                };
                
                displayWaveData(mockWaveData);
                
            } catch (error) {
                console.error('Error fetching wave data:', error);
                document.getElementById('wave-report-content').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Wave data unavailable</p>
                    </div>
                `;
            }
        }

        // Display wave data
        function displayWaveData(data) {
            document.getElementById('wave-height').textContent = data.height;
            document.getElementById('wave-direction').textContent = data.direction;
            document.getElementById('wave-period').textContent = data.period;
        }

        // Setup subscription form
        function setupSubscriptionForm() {
            const form = document.getElementById('subscription-form');
            const messageDiv = document.getElementById('subscription-message');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                
                // Show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Subscribing...';
                
                try {
                    const response = await fetch(`${BASE_API_URL}/subscribe`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email: email })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        messageDiv.innerHTML = `
                            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                                <i class="fas fa-check mr-2"></i>
                                Successfully subscribed! You'll receive notifications when Lakewood Beach status changes.
                            </div>
                        `;
                        form.reset();
                    } else {
                        throw new Error(result.error || 'Subscription failed');
                    }
                    
                } catch (error) {
                    messageDiv.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            ${error.message}
                        </div>
                    `;
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 5 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }
            });
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            if (allBeaches.length > 0) {
                const latestUpdate = allBeaches.reduce((latest, beach) => {
                    const beachDate = new Date(beach.date);
                    return beachDate > latest ? beachDate : latest;
                }, new Date(0));
                
                document.getElementById('last-updated').textContent = 
                    latestUpdate.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: 'numeric', 
                        minute: '2-digit' 
                    });
            }
        }

        // Display error
        function displayError(message) {
            const statusDisplay = document.getElementById('status-display');
            const statusText = document.getElementById('status-text');
            const statusNote = document.getElementById('status-note');
            
            statusDisplay.innerHTML = '<span class="text-gray-500">‚ö†Ô∏è</span>';
            statusText.textContent = 'ERROR';
            statusNote.textContent = message;
        }
    </script>
</body>
</html> 